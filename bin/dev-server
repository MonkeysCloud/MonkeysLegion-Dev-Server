#!/usr/bin/env php
<?php

declare(strict_types=1);

/**
 * MonkeysLegion Dev Server CLI
 *
 * Usage:
 *   ./dev-server serve [--host=127.0.0.1] [--port=8000] [--watch]
 *   ./dev-server stop
 *   ./dev-server restart
 *   ./dev-server status
 */

// Find project root and autoloader
$autoloadPaths = [
    __DIR__ . '/vendor/autoload.php',
    __DIR__ . '/../vendor/autoload.php',
    __DIR__ . '/../../vendor/autoload.php',
    __DIR__ . '/../../../autoload.php',
];

$autoloaded = false;
foreach ($autoloadPaths as $path) {
    if (file_exists($path)) {
        require $path;
        $autoloaded = true;
        break;
    }
}

if (!$autoloaded) {
    fwrite(STDERR, "Error: Could not find vendor/autoload.php\n");
    fwrite(STDERR, "Please run: composer install\n");
    exit(1);
}

use MonkeysLegion\DevServer\DevServer;

// Parse command line arguments
$command = $argv[1] ?? 'serve';
$options = [];

// Parse options
for ($i = 2; $i < count($argv); $i++) {
    $arg = $argv[$i];

    if (strpos($arg, '--') === 0) {
        $arg = substr($arg, 2);
        if (strpos($arg, '=') !== false) {
            [$key, $value] = explode('=', $arg, 2);
            $options[$key] = $value;
        } else {
            $options[$arg] = true;
        }
    }
}

// Extract common options
$host = $options['host'] ?? '127.0.0.1';
$port = isset($options['port']) ? (int)$options['port'] : 8000;
$watch = isset($options['watch']) || isset($options['w']);
$docRoot = $options['docroot'] ?? $options['doc-root'] ?? null;

// Execute command
switch ($command) {
    case 'serve':
    case 'start':
        $server = new DevServer();
        $server->serve($host, $port, $docRoot, $watch);
        break;

    case 'stop':
        DevServer::stop();
        break;

    case 'restart':
        DevServer::restart($host, $port);
        break;

    case 'status':
        DevServer::status();
        break;

    case 'help':
    case '--help':
    case '-h':
        showHelp();
        break;

    default:
        fwrite(STDERR, "Unknown command: {$command}\n\n");
        showHelp();
        exit(1);
}

function showHelp(): void
{
    echo <<<'HELP'
MonkeysLegion Dev Server - Hot-reload development server

USAGE:
    ./dev-server <command> [options]

COMMANDS:
    serve           Start the development server (default)
    stop            Stop the running server
    restart         Restart the server
    status          Show server status
    help            Show this help message

OPTIONS:
    --host=HOST     Server host (default: 127.0.0.1)
    --port=PORT     Server port (default: 8000)
    --watch, -w     Enable hot-reload file watching
    --docroot=PATH  Document root path (default: public)

EXAMPLES:
    # Start server with hot-reload
    ./dev-server serve --watch

    # Start on custom port
    ./dev-server serve --port=3000

    # Start with custom host and port
    ./dev-server serve --host=0.0.0.0 --port=8080 --watch

    # Check server status
    ./dev-server status

    # Stop the server
    ./dev-server stop

    # Restart the server
    ./dev-server restart

NOTES:
    - Hot-reload requires the dev-reload.js script in your public/js/ directory
    - Make sure APP_ENV=development is set in your .env file
    - The server runs in the background; use 'stop' to terminate it

HELP;
}

